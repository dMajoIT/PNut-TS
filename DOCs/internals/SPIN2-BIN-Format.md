# SPIN2/PASM2 Binary File Format (.bin) Documentation

## Overview

This document describes the internal structure of the binary files (.bin) generated by the PNut-TS compiler for Parallax Propeller 2 (P2) microcontrollers. The binary format is designed to be compatible with the original Windows PNut compiler.

## File Structure Hierarchy

The PNut-TS compiler generates .bin files through a multi-stage process:

1. **Object Image Generation** - Core binary content created by `ObjectImage` class
2. **Child Object Assembly** - Multiple objects combined by `ChildObjectsImage` class
3. **Binary File Output** - Final .bin file written by `writeBinaryFile()` method

## Binary File Format Layout

The final binary format varies significantly depending on the compilation mode and options. The compiler can insert multiple optional components that fundamentally change the memory layout.

### Binary Format Variants

#### 1. **Basic .bin File (SPIN2 Mode)**
- Core object with SPIN2 interpreter
- Clock setter (conditional)
- Debugger (optional)

#### 2. **PASM2 .bin File (PASM Mode)**
- Standalone PASM2 code
- Clock setter (conditional)
- No interpreter required

#### 3. **Flash .binf File (Download Mode)**
- Flash loader at offset 0x0000
- Application code at offset 0x0400
- Dual checksums

### Complete Binary Layout Structure

Based on analysis of `ComposeRam()` in `spin2Parser.ts:448` and component insertion methods:

#### SPIN2 Mode Binary Layout (.bin file):

```
Complete SPIN2 Binary Layout:
┌─────────────────────────────────────────────────────────────┐
│ OPTIONAL: DEBUGGER SECTION (if debug mode)                 │
├─────────────────────────────────────────────────────────────┤
│ 0x0000: Spin2_debugger.obj (16KB fixed size)               │
│         - Debug data appended after debugger               │
│         - Clock/frequency settings patched                 │
│         - Application size and debug symbols patched       │
├─────────────────────────────────────────────────────────────┤
│ OPTIONAL: CLOCK SETTER SECTION (if CLKMODE != 0b00)        │
├─────────────────────────────────────────────────────────────┤
│ Next:   clock_setter.obj (variable size)                   │
│         - Clock mode and frequency patched                 │
│         - Unused instructions NOPed based on mode          │
├─────────────────────────────────────────────────────────────┤
│ SPIN2 INTERPRETER SECTION (always present in SPIN2 mode)   │
├─────────────────────────────────────────────────────────────┤
│ Next:   Spin2_interpreter.obj (variable size)              │
│         - pbase_init, vbase_init, var_longs patched        │
│         - Clock mode/frequency patched                     │
│         - Debug NOPs patched if not debug mode             │
├─────────────────────────────────────────────────────────────┤
│ APPLICATION OBJECT SECTION (user code)                     │
├─────────────────────────────────────────────────────────────┤
│ Next:   LONG varsize    (Variable memory requirement)      │
│ Next:   LONG pgmsize    (Program section length)           │
├─────────────────────────────────────────────────────────────┤
│ Next:   OBJECT TABLE (starts at pbase offset)              │
├─────────────────────────────────────────────────────────────┤
│ Child Object Entries:                                       │
│   LONG ($7FFF_FFFF & OBJ_n_offset), OBJ_n_var_offset      │
├─────────────────────────────────────────────────────────────┤
│ PUB Method Entries:                                         │
│   LONG ($8000_0000 | params<<24 | results<<20 | offset)    │
├─────────────────────────────────────────────────────────────┤
│ PRI Method Entries:                                         │
│   LONG ($8000_0000 | params<<24 | results<<20 | offset)    │
├─────────────────────────────────────────────────────────────┤
│ End Marker: LONG ($7FFF_FFFF & objsize)                    │
├─────────────────────────────────────────────────────────────┤
│ CODE AND DATA SECTION                                       │
├─────────────────────────────────────────────────────────────┤
│ BYTE[] DAT data...   (Data declarations)                   │
│ BYTE[] PUB data...   (PUBLIC method bytecode)              │
│ BYTE[] PRI data...   (PRIVATE method bytecode)             │
├─────────────────────────────────────────────────────────────┤
│ CHILD OBJECTS SECTION (LONG aligned)                       │
├─────────────────────────────────────────────────────────────┤
│ BYTE[] Child object binaries (complete recursive format)   │
├─────────────────────────────────────────────────────────────┤
│ SYMBOL TABLE SECTION (file format only, at pgmsize)        │
├─────────────────────────────────────────────────────────────┤
│ BYTE   checksum      (Negative sum validation)             │
│ BYTE[] 'PUB_n', 0..15 results, parameters                  │
│ BYTE[] 'CON_n', 16/17 int/float, LONG value               │
└─────────────────────────────────────────────────────────────┘
```

#### PASM2 Mode Binary Layout (.bin file):

```
PASM2 Binary Layout (no interpreter):
┌─────────────────────────────────────────────────────────────┐
│ OPTIONAL: CLOCK SETTER SECTION (if CLKMODE != 0b00)        │
├─────────────────────────────────────────────────────────────┤
│ 0x0000: clock_setter.obj (if needed)                       │
├─────────────────────────────────────────────────────────────┤
│ APPLICATION SECTION (starts at 0x0000 or after clock)      │
├─────────────────────────────────────────────────────────────┤
│ Raw PASM2 code and data                                     │
│ - Compiled assembly instructions                            │
│ - Data declarations from DAT sections                      │
└─────────────────────────────────────────────────────────────┘
```

#### Flash Download Binary Layout (.binf file):

```
Flash Binary Layout (.binf):
┌─────────────────────────────────────────────────────────────┐
│ FLASH LOADER SECTION (fixed 1KB)                           │
├─────────────────────────────────────────────────────────────┤
│ 0x0000: flash_loader.obj subset (0x1F0 bytes)              │
│         - Application long count patched at _appLongs_     │
│         - Application checksum patched at _appSum_         │
│ 0x01F0: Padding to 0x0400                                  │
│ 0x03FC: Flash loader checksum (negative sum)               │
├─────────────────────────────────────────────────────────────┤
│ APPLICATION SECTION (starts at 0x0400)                     │
├─────────────────────────────────────────────────────────────┤
│ 0x0400: Complete application binary                        │
│         - Same format as .bin file                         │
│         - Can include debugger, interpreter, clock setter  │
│         - Separate application checksum                    │
└─────────────────────────────────────────────────────────────┘
```

## Optional Component Details

### 1. SPIN2 Interpreter (`P2InsertInterpreter()`)

**When Included**: Always present in SPIN2 mode (non-PASM2)
**Source**: `Spin2_interpreter.obj` (external file)
**Location**: `src/classes/spin2Parser.ts:536`

**Insertion Process**:
1. Load interpreter binary from external file
2. Move user object upward to make space
3. Place interpreter at beginning of binary (offset 0x0000)
4. Patch interpreter with runtime parameters:
   - `pbase_init` (0x30): Set to interpreter length
   - `vbase_init` (0x34): Set to interpreter + object length
   - `var_longs` (0x3C): Variable space in longs + stack (0x400)
   - `clkmode_hub` (0x40): Clock mode setting
   - `clkfreq_hub` (0x44): Clock frequency
   - `_debugnop_` (0xF2C): NOP debug instructions if not debug mode

**Size**: Variable (typically 1-2KB)

### 2. Clock Setter (`P2InsertClockSetter()`)

**When Included**:
- PASM2 mode AND clockMode != 0b00
- Not in debug mode
- `_AUTOCLK` not defined or != 0

**Source**: `clock_setter.obj` (external file)
**Location**: `src/classes/spin2Parser.ts:870`

**Insertion Process**:
1. Load clock setter binary from external file
2. Move existing content upward to make space
3. Place clock setter at beginning (offset 0x0000)
4. Patch clock parameters:
   - `_clkmode1_` (0x20): Clock mode & 0xFFFFFFFC
   - `_clkmode2_` (0x24): Full clock mode
   - `_appblocks_` (0x3C): Number of 512-long blocks in application
5. NOP unused instructions based on clock mode (RC_SLOW vs external)

**Size**: Variable (hundreds of bytes)

### 3. Debugger (`P2InsertDebugger()`)

**When Included**: Debug mode enabled (`--debug` flag)
**Source**: `Spin2_debugger.obj` (external file)
**Location**: `src/classes/spin2Parser.ts:655`

**Requirements**:
- Clock mode must have crystal/external clocking (bit 1 set)
- Clock frequency must be >= 10MHz

**Insertion Process**:
1. Move existing content upward by debugger + debug data size
2. Place debugger at beginning (offset 0x0000)
3. Append debug data immediately after debugger
4. Patch debugger parameters:
   - `_appsize_` (0xD0): Size of application code
   - `_clkfreq_` (0xD4): Clock frequency
   - `_clkmode1_` (0xD8): Clock mode & 0xFFFFFFFC
   - `_clkmode2_` (0xDC): Full clock mode
   - Debug symbol addresses and configurations

**Size**: Fixed 16KB (0x4000 bytes) + debug data

### 4. Flash Loader (`P2InsertFlashLoader()`)

**When Included**: Flash programming mode (`--flash` flag)
**Source**: `flash_loader.obj` (external file, subset used)
**Location**: `src/classes/spin2Parser.ts:818`

**Special Properties**:
- Only first 0x1F0 bytes of loader used
- Fixed 1KB total section (0x400 bytes)
- Application starts at 0x0400 offset
- Dual checksum system

**Insertion Process**:
1. Pad application to LONG boundary
2. Move application to offset 0x0400
3. Copy flash loader subset (0x1F0 bytes) to beginning
4. Patch loader parameters:
   - `_appLongs_` (0x1C): Application size in longs
   - `_appSum_` (0x1F4): Negative sum of application
5. Calculate flash loader checksum (0x3FC)

**Size**: Fixed 1KB (0x400 bytes)

## Binary Layout Components

### 1. Application Header Section (8 bytes)

- **varsize** (LONG at 0x0000): Total variable memory required by this object
- **pgmsize** (LONG at 0x0004): Length of the program section (up to symbol table)

### 2. Object Table Section

Starting at `pbase` (offset 0x0008), contains:

#### Child Object Entries
- Format: `LONG ($7FFF_FFFF & obj_offset), obj_var_offset`
- One entry per child object referenced by this object
- `obj_offset`: Byte offset to child object data within this file
- `obj_var_offset`: Variable space offset for this child object

#### Method Entries
- **PUBLIC Methods**: `LONG ($8000_0000 | parameters<<24 | results<<20 | method_offset)`
- **PRIVATE Methods**: `LONG ($8000_0000 | parameters<<24 | results<<20 | method_offset)`
- `parameters`: Number of input parameters (0-15)
- `results`: Number of return values (0-15)
- `method_offset`: Byte offset to method bytecode

#### End Marker
- `LONG ($7FFF_FFFF & objsize)`: Marks end of object table, points past last method

### 3. Code and Data Section

Contains the actual executable content:
- **DAT data**: Data declarations and initialized values
- **PUB data**: PUBLIC method bytecode
- **PRI data**: PRIVATE method bytecode

### 4. Child Objects Section

- Aligned to LONG (4-byte) boundaries
- Contains complete binary images of all referenced child objects
- Each child object follows the same format recursively

### 5. Symbol Table Section (File Format Only)

Present in .bin files but not in runtime memory:
- **Checksum byte**: Negative sum of all preceding bytes for validation
- **PUB symbols**: Method names with parameter/return counts
- **CON symbols**: Constant names with types and values

## Object Image Implementation

### ObjectImage Class

The `ObjectImage` class (`src/classes/objectImage.ts`) provides the core binary generation:

- **Dynamic Memory**: Grows in 128KB chunks up to 2MB limit
- **Little-endian**: All multi-byte values stored in little-endian format
- **Append Operations**: `appendByte()`, `appendWord()`, `appendLong()`
- **Random Access**: `read()`, `readWord()`, `readLong()` at any offset
- **Replacement**: `replaceByte()`, `replaceWord()`, `replaceLong()` for patching

### ChildObjectsImage Class

The `ChildObjectsImage` class (`src/classes/childObjectsImage.ts`) manages multiple objects:

- **File Tracking**: Records offset and length for each child object
- **Duplicate Detection**: Prevents inclusion of identical child objects
- **Sequential Access**: Provides `nextByte()`, `nextWord()`, `nextLong()` methods
- **Validation**: Checksum calculation for object integrity

## Binary Generation Process

### Phase 1: Object Compilation
1. Parse source files and resolve symbols
2. Generate bytecode for methods
3. Collect DAT section data
4. Build symbol tables

### Phase 2: Object Assembly
1. Write header (varsize, pgmsize)
2. Build object table with method and child object references
3. Append code and data sections
4. Include child object binaries
5. Calculate and append checksum
6. Append symbol tables

### Phase 3: Binary Output
1. Extract final binary data from ObjectImage
2. Write to .bin file via `writeBinaryFile()`
3. Optional flash loader insertion for .binf files

## Validation and Integrity

### Checksum Algorithm
```typescript
// Negative sum checksum calculation
let checkSum = 0;
for (let offset = 0; offset < objImage.length; offset++) {
    checkSum -= objImage.readByte(offset);
}
checkSum = checkSum & 0xFF; // Final checksum byte
```

### Object Validation
- Checksum must equal zero when all bytes (including checksum) are summed
- varsize and pgmsize must be LONG-aligned (multiple of 4)
- Object table entries must reference valid offsets within the file

## Flash Loader Integration

For downloadable binaries (.binf), an additional flash loader is prepended:

- **Loader Size**: Fixed at 1KB (0x400 bytes)
- **Application Offset**: Main object starts at 0x400
- **Dual Checksums**: Separate checksums for loader and application
- **Validation**: Both checksums validated independently

## Memory Organization at Runtime

When loaded into P2 memory:
1. **Header**: Used for memory allocation and validation
2. **Object Table**: Referenced for method calls and object access
3. **Code Section**: Executed by P2 interpreter
4. **Data Section**: Accessed as variables and constants
5. **Symbol Table**: Discarded after loading (file format only)

## Development Notes

### Key Source Files
- `src/classes/objectImage.ts` - Core binary image management
- `src/classes/childObjectsImage.ts` - Multi-object assembly
- `src/classes/spin2Parser.ts` - Binary generation coordination
- `src/classes/spinResolver.ts` - Object structure definition (lines 4603-4626)

### Compatibility
- Binary format matches original PNut compiler (Windows)
- Supports both SPIN2 and PASM2 code generation
- Compatible with existing P2 development tools

## Assembly Order and Component Priority

The final binary assembly follows a specific order in `ComposeRam()`:

### Assembly Sequence
1. **Application Compilation**: Core object code generated first
2. **Interpreter Insertion**: SPIN2 interpreter added (SPIN2 mode only)
3. **Hub Memory Check**: Verify size limits before optional components
4. **Debugger Insertion**: Debug components added (debug mode only)
5. **Clock Setter Insertion**: Clock configuration added (PASM2 mode, conditional)
6. **Flash Loader Preparation**: Non-flash binary saved for comparison
7. **Flash Loader Insertion**: Flash components added (flash mode only)
8. **Binary Output**: Final .bin/.binf files written

### Memory Layout Priority
When multiple components are present, the memory layout follows this order:

**For Standard .bin Files**:
```
[Debugger] → [Clock Setter] → [Interpreter] → [Application Object]
```

**For Flash .binf Files**:
```
[Flash Loader (1KB)] → [Debugger] → [Clock Setter] → [Interpreter] → [Application Object]
```

### External File Dependencies

The compiler depends on these external binary files (in `extension/` folder):

**Required Files**:
- `Spin2_interpreter.obj` - SPIN2 bytecode interpreter (v43)
- `Spin2_debugger.obj` - Debug support system (v43)
- `clock_setter.obj` - Clock configuration code
- `flash_loader.obj` - Flash programming support

**Optional Version Support**:
- `spin2_interpreter_v44.obj` - SPIN2 interpreter (v44, controlled by flag)
- `Spin2_debugger_v44.obj` - Debug system (v44, controlled by flag)

**File Loading**: Managed by `ExternalFiles` class (`src/classes/externalFiles.ts:67`)

### Hub Memory Limits

The compiler enforces P2 hub memory constraints:

- **Standard Limit**: 512KB hub RAM
- **Debug Overhead**: +16KB for debugger
- **Interpreter Overhead**: Variable (1-2KB typical)
- **Stack Space**: +1KB (0x400 bytes)
- **Flash Loader Overhead**: +1KB for flash downloads

Total memory calculation:
```typescript
objSize = executableSize +
          (debugMode ? 0x4000 : 0) +
          (spin2Mode ? interpreterSize + variableSize + 0x400 : 0)
```

### Checksum Systems

#### Single Checksum (.bin files)
- **Algorithm**: Negative sum of all bytes
- **Location**: After symbol table at end of file
- **Scope**: Entire file content

#### Dual Checksum (.binf files)
- **Flash Loader Checksum**: Negative sum of first 1KB
- **Application Checksum**: Negative sum of application section only
- **Validation**: Both checksums validated independently

This comprehensive format documentation enables understanding of the complete internal structure of .bin/.binf files generated by PNut-TS for debugging, analysis, and toolchain development purposes.